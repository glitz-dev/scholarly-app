<?xml version="1.0" encoding="utf-8" ?>
<!-- 
  This NLog configuration is now controlled by appsettings.json
  See appsettings.json > NLog section for configuration
  This file is kept for backwards compatibility and as a fallback
-->
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true"
      throwConfigExceptions="true"
      internalLogLevel="warn"
      internalLogFile="${basedir}/logs/internal-nlog.txt">
	
	<extensions>
		<add assembly="NLog.Web.AspNetCore"/>
		<add assembly="NLog.Database"/>
	</extensions>

	<!-- 
		NOTE: This configuration is overridden by appsettings.json
		To modify logging behavior, edit appsettings.json > NLog section
	-->
	
	<targets async="true">
		<!-- Console Target -->
		<target xsi:type="ColoredConsole" 
				name="logconsole"
				layout="${longdate}|${level:uppercase=true}|${logger}|${message} ${exception:format=tostring}">
			<highlight-row condition="level == LogLevel.Debug" foregroundColor="DarkGray" />
			<highlight-row condition="level == LogLevel.Info" foregroundColor="Gray" />
			<highlight-row condition="level == LogLevel.Warn" foregroundColor="Yellow" />
			<highlight-row condition="level == LogLevel.Error" foregroundColor="Red" />
			<highlight-row condition="level == LogLevel.Fatal" foregroundColor="Red" backgroundColor="White" />
		</target>

	<!-- File Target -->
	<target xsi:type="File" 
			name="logfile"
			fileName="${basedir}/logs/scholarly-${shortdate}.log"
			layout="${longdate}|${level:uppercase=true}|${logger}|${message} ${exception:format=tostring}|${aspnet-request-url}|${aspnet-mvc-action}"
			archiveFileName="${basedir}/logs/archives/scholarly-{#}.log"
			archiveEvery="Day"
			archiveNumbering="Rolling"
			maxArchiveFiles="7"
			keepFileOpen="false"
			enableFileDelete="true" />

		<!-- Database Target -->
		<target xsi:type="Database" 
				name="logdatabase"
				dbProvider="Npgsql.NpgsqlConnection, Npgsql"
				connectionString="${configsetting:name=ConnectionStrings.DefaultConnection}">
			<commandText>
				INSERT INTO Log (Logged, Level, Message, Logger, Exception, UserName, Url, ServerName) 
				VALUES (CAST(@Logged AS timestamp), @Level, @Message, @Logger, @Exception, @UserName, @Url, @ServerName);
			</commandText>
			<parameter name="@Logged" layout="${date}" />
			<parameter name="@Level" layout="${level}" />
			<parameter name="@Message" layout="${message}" />
			<parameter name="@Logger" layout="${logger}" />
			<parameter name="@Exception" layout="${exception:tostring}" />
			<parameter name="@UserName" layout="${aspnet-user-identity}" />
			<parameter name="@Url" layout="${aspnet-request-url}" />
			<parameter name="@ServerName" layout="${machinename}" />
		</target>
	</targets>

	<!-- 
		Default Rules - Can be overridden by appsettings.json
	-->
	<rules>
		<!-- Skip Microsoft logs with lower severity -->
		<logger name="Microsoft.*" maxlevel="Info" final="true" />
		<logger name="System.Net.Http.*" maxlevel="Info" final="true" />
		
		<!-- Application logs -->
		<logger name="*" minlevel="Trace" writeTo="logconsole" />
		<logger name="*" minlevel="Debug" writeTo="logfile" />
		<logger name="*" minlevel="Info" writeTo="logdatabase" />
	</rules>
</nlog>

